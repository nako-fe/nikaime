# -*- coding: utf-8 -*-
"""kakeibo.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1QgH_yV-6gM4f0-yTTvAF1LBxbhcYZbWh
"""

import streamlit as st
import pandas as pd
from datetime import datetime
import os

# â˜…è¿½åŠ ï¼šãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«åã‚’å®šç¾©
DATA_FILE = "expenses.csv"
SETTINGS_FILE = "settings.csv" # â˜…è¿½åŠ ï¼šè¨­å®šä¿å­˜ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«å

# --- ã‚¢ãƒ—ãƒªã®ã‚¿ã‚¤ãƒˆãƒ« ---
st.title("æ”¯å‡ºç®¡ç†ã‚¢ãƒ—ãƒª")

# --- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ– ---
# æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹DataFrameã‚’åˆæœŸåŒ–
if "expenses_df" not in st.session_state:
    if os.path.exists(DATA_FILE): # â˜…å¤‰æ›´ï¼šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        try:
            st.session_state.expenses_df = pd.read_csv(DATA_FILE)
            # â˜…è¿½åŠ ï¼šCSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã æ—¥ä»˜ã‚«ãƒ©ãƒ ã‚’datetimeå‹ã«å¤‰æ›
            st.session_state.expenses_df["æ—¥ä»˜"] = pd.to_datetime(st.session_state.expenses_df["æ—¥ä»˜"])
        except pd.errors.EmptyDataError: # â˜…è¿½åŠ ï¼šãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã®å ´åˆã®å‡¦ç†
            st.session_state.expenses_df = pd.DataFrame(columns=["æ—¥ä»˜", "ã‚«ãƒ†ã‚´ãƒª", "é‡‘é¡", "ãƒ¡ãƒ¢"])
        except Exception as e: # â˜…è¿½åŠ ï¼šãã®ä»–ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®å‡¦ç†
            st.error(f"ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            st.session_state.expenses_df = pd.DataFrame(columns=["æ—¥ä»˜", "ã‚«ãƒ†ã‚´ãƒª", "é‡‘é¡", "ãƒ¡ãƒ¢"])
    else: # â˜…å¤‰æ›´ï¼šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
        st.session_state.expenses_df = pd.DataFrame(columns=["æ—¥ä»˜", "ã‚«ãƒ†ã‚´ãƒª", "é‡‘é¡", "ãƒ¡ãƒ¢"])

if "categories" not in st.session_state:
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã€‚
    st.session_state.categories = ["é£Ÿè²»", "äº¤é€šè²»", "å¨¯æ¥½è²»", "å›ºå®šè²»", "ãã®ä»–"]

# ä½¿ã„ã™ããƒ©ã‚¤ãƒ³ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§ç®¡ç†
if "overspend_limit" not in st.session_state:
    if os.path.exists(SETTINGS_FILE):
        try:
            settings_df = pd.read_csv(SETTINGS_FILE)
            if 'overspend_limit' in settings_df.columns and not settings_df.empty:
                st.session_state.overspend_limit = int(settings_df.loc[0, 'overspend_limit'])
            else:
                st.session_state.overspend_limit = 50000 # ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚‹ãŒè¨­å®šå€¤ãŒãªã„å ´åˆ
        except Exception as e:
            st.error(f"è¨­å®šã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            st.session_state.overspend_limit = 50000 # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    else:
        st.session_state.overspend_limit = 50000 # ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤


st.markdown("---") # åŒºåˆ‡ã‚Šç·šã‚’è¿½åŠ 

# --- ä½¿ã„ã™ããƒ©ã‚¤ãƒ³ã®è¨­å®šUI ---
st.sidebar.header("è¨­å®š")
new_limit = st.sidebar.number_input(
    "æœˆé–“ã®ä½¿ã„ã™ããƒ©ã‚¤ãƒ³ (å††)",
    min_value=0,
    value=st.session_state.overspend_limit,
    step=1000,
    key="overspend_limit_input" # ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚­ãƒ¼ã‚’è¨­å®š
)

# â˜…è¿½åŠ ï¼šCSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
def save_expenses():
    st.session_state.expenses_df.to_csv(DATA_FILE, index=False)
def save_settings():
    settings_df = pd.DataFrame({'overspend_limit': [st.session_state.overspend_limit]})
    settings_df.to_csv(SETTINGS_FILE, index=False)

# å…¥åŠ›å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã€ä¿å­˜
if new_limit != st.session_state.overspend_limit:
    st.session_state.overspend_limit = new_limit
    save_settings() # â˜…è¿½åŠ ï¼šè¨­å®šå¤‰æ›´æ™‚ã«CSVã«ä¿å­˜ï¼
    st.rerun() # â˜…è¿½åŠ ï¼šç”»é¢ã‚’å³åº§ã«æ›´æ–°ã—ã¦è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚’åæ˜ 

# --- æ”¯å‡ºå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  ---
st.header("æ–°ã—ã„æ”¯å‡ºã‚’è¨˜éŒ²")

# å…¥åŠ›ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®ä½œæˆ
# æ—¥ä»˜ã¯ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
date = st.date_input("æ—¥ä»˜", datetime.now())

# ã‚«ãƒ†ã‚´ãƒªã®é¸æŠè‚¢ã«ã€Œæ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ...ã€ã‚’è¿½åŠ 
display_categories = st.session_state.categories + ["æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ..."]
selected_category = st.selectbox("ã‚«ãƒ†ã‚´ãƒª", display_categories)

# ã€Œæ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ...ã€ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
if selected_category == "æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ...":
    new_custom_category = st.text_input("æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
    if st.button("ã‚«ãƒ†ã‚´ãƒªã‚’ç¢ºå®š"):
        if new_custom_category and new_custom_category not in st.session_state.categories:
            st.session_state.categories.append(new_custom_category)
            # æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹ã«ã™ã‚‹ãŸã‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã«ä¿å­˜
            st.session_state.last_selected_category = new_custom_category
            st.success(f"ã‚«ãƒ†ã‚´ãƒªã€Œ{new_custom_category}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼")
            st.rerun() # ã‚¢ãƒ—ãƒªã‚’å†å®Ÿè¡Œã—ã¦ selectbox ã‚’æ›´æ–°
        elif new_custom_category in st.session_state.categories:
            st.warning("ãã®ã‚«ãƒ†ã‚´ãƒªã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚")
        else:
            st.warning("ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    # ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªãŒç¢ºå®šã•ã‚Œã‚‹ã¾ã§ã¯ã€é¸æŠã‚«ãƒ†ã‚´ãƒªã‚’ä»®ã«ç©ºç™½ã«ã™ã‚‹ã‹ã€é©åˆ‡ãªåˆæœŸå€¤ã«è¨­å®š
    category_to_record = "" # ã“ã“ã§ã¯ç©ºã«ã—ã¦ãŠãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºå®šã™ã‚‹ã¾ã§è¨˜éŒ²ã—ãªã„
else:
    category_to_record = selected_category

amount = st.number_input("é‡‘é¡", min_value=0, value=0, step=100)
memo = st.text_input("ãƒ¡ãƒ¢ (ä»»æ„)")

# æ”¯å‡ºè¿½åŠ ãƒœã‚¿ãƒ³
# æ”¯å‡ºè¿½åŠ ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸéš›ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚‚èª¿æ•´
if st.button("æ”¯å‡ºã‚’è¿½åŠ "):
    # æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ã®æ“ä½œä¸­ã§ã¯ãªã„ã‹ã€ã¾ãŸã¯ã‚«ãƒ†ã‚´ãƒªãŒæœ‰åŠ¹ã‹ã‚’ç¢ºèª
    if category_to_record and amount > 0: # category_to_record ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
        # æ–°ã—ã„æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’DataFrameã«è¿½åŠ 
        new_expense = pd.DataFrame([{
            "æ—¥ä»˜": pd.Timestamp(date),
            "ã‚«ãƒ†ã‚´ãƒª": category_to_record, # ã“ã“ã§ç¢ºå®šã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚’ä½¿ç”¨
            "é‡‘é¡": amount,
            "ãƒ¡ãƒ¢": memo
        }])
        st.session_state.expenses_df = pd.concat([st.session_state.expenses_df, new_expense], ignore_index=True)
        save_expenses() # â˜…è¿½åŠ ï¼šæ”¯å‡ºè¿½åŠ å¾Œã«CSVã«ä¿å­˜ï¼
        st.success("æ”¯å‡ºã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼")
        # æœ€å¾Œã«é¸æŠãƒ»è¿½åŠ ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’è¨˜æ†¶ã•ã›ã¦ãŠãã¨ã€æ¬¡ã®å…¥åŠ›ãŒæ¥½ã«ãªã‚‹
        if selected_category != "æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ...": # æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã¯è¨˜æ†¶ã—ãªã„
            st.session_state.last_selected_category = selected_category
        # st.experimental_rerun() # å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    elif amount <= 0:
        st.warning("é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        st.warning("ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã¾ãŸã¯è¿½åŠ ã—ã¦ãã ã•ã„ã€‚") # æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãŒæœªå®Œäº†ã®å ´åˆ


### è¨˜éŒ²ã•ã‚ŒãŸæ”¯å‡ºä¸€è¦§

st.header("è¨˜éŒ²ã•ã‚ŒãŸæ”¯å‡º")

if not st.session_state.expenses_df.empty:
    # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„ã‚‚ã®ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é™é †ï¼‰
    sorted_df = st.session_state.expenses_df.sort_values(by="æ—¥ä»˜", ascending=False)
    display_df = sorted_df.copy()
    display_df["æ—¥ä»˜"] = display_df["æ—¥ä»˜"].dt.strftime("%Y-%m-%d")
    st.dataframe(display_df, use_container_width=True)

    st.markdown("---")

    # --- æœˆã”ã¨ã®æ”¯å‡ºåˆè¨ˆ ---
    st.header("æœˆã”ã¨ã®æ”¯å‡ºåˆè¨ˆ")

    # æ—¥ä»˜ã‚’å¹´æœˆã®å½¢å¼ã«å¤‰æ›
    # DatetimeIndex.strftime ã‚’æ¨å¥¨
    # pd.to_datetimeã¯è¦ç´ ã”ã¨ã«datetimeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã€ãã®å¾Œã«strftime
    st.session_state.expenses_df["æœˆ"] = pd.to_datetime(st.session_state.expenses_df["æ—¥ä»˜"]).dt.strftime("%Yå¹´%mæœˆ")
    monthly_summary = st.session_state.expenses_df.groupby("æœˆ")["é‡‘é¡"].sum().reset_index()

    # æœˆã¨ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
    monthly_summary = st.session_state.expenses_df.groupby("æœˆ")["é‡‘é¡"].sum().reset_index()
    monthly_summary = monthly_summary.sort_values(by="æœˆ", ascending=False) # æœˆã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ

    st.dataframe(monthly_summary, use_container_width=True)

    st.markdown("---")

     # --- ä½¿ã„ã™ãè­¦å‘Šã®è¡¨ç¤º ---
    current_month = datetime.now().strftime("%Yå¹´%mæœˆ")
    # ä»Šæœˆã®æ”¯å‡ºåˆè¨ˆã‚’è¨ˆç®—
    current_month_total = monthly_summary[monthly_summary["æœˆ"] == current_month]["é‡‘é¡"].sum()

    if current_month_total > st.session_state.overspend_limit:
        # Markdown ã‚’ä½¿ã£ã¦è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤§ããè¡¨ç¤º
        st.error(f"ğŸš¨ **è­¦å‘Šï¼ä»Šæœˆã®æ”¯å‡ºã¯{current_month_total:,.0f}å††ã§ã€è¨­å®šãƒ©ã‚¤ãƒ³({st.session_state.overspend_limit:,.0f}å††)ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ä½¿ã„ã™ãã§ã™ï¼**")
    elif current_month_total > st.session_state.overspend_limit * 0.8: # 80%ã‚’è¶…ãˆãŸã‚‰æ³¨æ„ã‚’ä¿ƒã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        st.warning(f"âš ï¸ ä»Šæœˆã®æ”¯å‡ºã¯{current_month_total:,.0f}å††ã§ã™ã€‚è¨­å®šãƒ©ã‚¤ãƒ³({st.session_state.overspend_limit:,.0f}å††)ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ï¼")
    else:
        st.success(f"âœ… ä»Šæœˆã®æ”¯å‡ºã¯{current_month_total:,.0f}å††ã§ã™ã€‚è¨­å®šãƒ©ã‚¤ãƒ³({st.session_state.overspend_limit:,.0f}å††)ã¾ã§ã¾ã ä½™è£•ãŒã‚ã‚Šã¾ã™ã€‚")
    st.markdown("---") # è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸‹ã«ã‚‚åŒºåˆ‡ã‚Šç·šã‚’è¿½åŠ 

    # --- ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºåˆè¨ˆ (ä»Šæœˆåˆ†ã®ã¿) ---
    st.header("ä»Šæœˆã®ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º")

    # ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    current_month = datetime.now().strftime("%Yå¹´%mæœˆ")
    this_month_expenses = st.session_state.expenses_df[st.session_state.expenses_df["æœˆ"] == current_month]

    if not this_month_expenses.empty:
        category_summary = this_month_expenses.groupby("ã‚«ãƒ†ã‚´ãƒª")["é‡‘é¡"].sum().reset_index()
        st.dataframe(category_summary, use_container_width=True)

        # å††ã‚°ãƒ©ãƒ•ã§å¯è¦–åŒ– (Plotly Express ã‚’ä½¿ç”¨)
        import plotly.express as px
        fig = px.pie(category_summary, values='é‡‘é¡', names='ã‚«ãƒ†ã‚´ãƒª', title=f'{current_month} ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºå‰²åˆ')
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("ä»Šæœˆã®æ”¯å‡ºã¯ã¾ã è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")

else:
    st.info("ã¾ã æ”¯å‡ºãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸Šã«æ–°ã—ã„æ”¯å‡ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# --- ã‚¢ãƒ—ãƒªæƒ…å ±ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ ---
# st.sidebar.write("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ :")
# st.sidebar.write(st.session_state.expenses_df)